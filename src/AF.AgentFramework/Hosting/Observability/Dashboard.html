<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AF.AgentFramework Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family:sans-serif; margin:2em; background:#fafafa; }
        h2 { color:#333; }
        #summary { margin-bottom:1em; }
        table { border-collapse:collapse; width:100%; margin-top:1em; background:white; }
        th,td { border:1px solid #ddd; padding:6px 8px; text-align:left; }
        th { background:#f0f0f0; }
        .warn { background:#fff6e0; }
        .alert { background:#ffe6e6; }
        canvas { max-height:180px; margin-top:1.5em; }
        .sparkline { width:120px; height:40px; }
        .observation { margin-top:1em; font-size:0.9em; background:#fdfdfd; border:1px solid #ccc; padding:8px; border-radius:4px; }
    </style>
</head>
<body>
<h2>AF.AgentFramework Dashboard</h2>
<div id="summary">Loading‚Ä¶</div>

<canvas id="throughputChart"></canvas>

<table id="agents">
    <tr>
        <th>Agent</th>
        <th>Queue</th>
        <th>Œî/s</th>
        <th>Avg ms</th>
        <th>Util%</th>
        <th>Rej</th>
        <th>Handled</th>
        <th>Status</th>
    </tr>
</table>

<div id="observations" class="observation"></div>

<script>
    const throughputCtx = document.getElementById('throughputChart').getContext('2d');
    const throughputChart = new Chart(throughputCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{ label: 'Throughput (items/s)', data: [], borderColor:'#512BD4', tension:0.2 }]
        },
        options: { animation:false, scales:{ y:{ beginAtZero:true } } }
    });

    const history = {}; // { agentId: {queue:[], util:[]} }

    async function refresh() {
        try {
            const r = await fetch('/af/snapshot');
            const j = await r.json();

            // --- summary ---
            document.getElementById('summary').textContent =
                `Agents: ${j.totalAgents} | Running: ${j.runningAgents} | Queued: ${j.queuedItems} | Handled: ${j.totalHandledItems} | Rejected: ${j.rejectedItems} | Throughput: ${j.throughputPerSecond.toFixed(2)}/s`;

            // --- throughput trend ---
            const ts = new Date(j.timestamp).toLocaleTimeString();
            throughputChart.data.labels.push(ts);
            throughputChart.data.datasets[0].data.push(j.throughputPerSecond);
            if (throughputChart.data.labels.length > 25) {
                throughputChart.data.labels.shift();
                throughputChart.data.datasets[0].data.shift();
            }
            throughputChart.update();

            // --- agents table ---
            const rows = j.agents.map(a => {
                const h = history[a.id] ??= { queue: [], util: [] };
                h.queue.push(a.queueLength);
                h.util.push(a.utilizationPercent);
                if (h.queue.length > 25) { h.queue.shift(); h.util.shift(); }

                let cls = '';
                if (a.queueLength >= 256) cls = 'alert';
                else if (a.queueLength >= 128) cls = 'warn';

                // subtle dimming for idle agents
                const opacity = a.totalHandled === 0 ? 0.5 : 1.0;
                const state = a.isRunning ? 'üü¢' : '‚ö™Ô∏è';

                return `<tr class="${cls}" style="opacity:${opacity}">
                    <td>${a.id}</td>
                    <td>${a.queueLength}</td>
                    <td>${a.queueGrowthRate.toFixed(1)}</td>
                    <td>${a.avgExecutionMs.toFixed(1)}</td>
                    <td>${a.utilizationPercent.toFixed(0)}</td>
                    <td>${a.rejected}</td>
                    <td>${a.totalHandled}</td>
                    <td>${state}</td>
                </tr>`;
            }).join('');
            document.getElementById('agents').innerHTML =
                `<tr><th>Agent</th><th>Queue</th><th>Œî/s</th><th>Avg ms</th><th>Util%</th><th>Rej</th><th>Handled</th><th>Status</th></tr>${rows}`;

            // --- observations ---
            const obs = [];
            j.agents.forEach(a => {
                if (a.queueLength > 200) obs.push(`‚ö†Ô∏è ${a.id} overloaded (${a.queueLength} queued)`);
                if (a.rejected > 0) obs.push(`‚ùå ${a.id} dropping work (${a.rejected} rejected)`);
                if (a.utilizationPercent < 10 && a.queueLength === 0) obs.push(`‚ÑπÔ∏è ${a.id} mostly idle`);
            });
            document.getElementById('observations').innerHTML =
                obs.length ? obs.join('<br>') : '‚úÖ All agents stable';

        } catch (err) {
            console.error(err);
            document.getElementById('summary').textContent = 'Error fetching snapshot';
        }
    }

    setInterval(refresh, 2000);
    refresh();
</script>
</body>
</html>
